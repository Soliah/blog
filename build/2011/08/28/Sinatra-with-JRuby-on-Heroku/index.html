<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='UTF-8'>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' name='viewport'>
    <link href="/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/syntax.css" media="screen" rel="stylesheet" type="text/css" />
    <link href='//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css' rel='stylesheet'>
  </head>
  <body>
    <div id='bar'></div>
    <div class='container'>
      <header>
        <div class='col-xs-7 col-md-6 nav'>
          <a href='/'>
            <span id="first">yield</span> <span id="second">@chow</span>
          </a>
        </div>
        <div class='col-xs-5 col-md-6 social'>
          <a href='mailto:chris@chowie.net'>
            <i class='icon-envelope-alt'></i>
          </a>
          <a href='https://twitter.com/Soliah'>
            <i class='icon-twitter'></i>
          </a>
          <a href='https://github.com/Soliah'>
            <i class='icon-github'></i>
          </a>
          <a href='http://stackoverflow.com/users/140578/soliah'>
            <i class='icon-stackexchange'></i>
          </a>
        </div>
      </header>
      <section class='content'>
        <div class='row'>
          <div class='col-md-12'>
            <div class='post'>
              <h1>Sinatra with JRuby on Heroku</h1>
              <time>Aug 28, 2011</time>
              <p><em><em>This post is now deprecated in favour of Heroku&rsquo;s <a href="https://github.com/jruby/heroku-buildpack-jruby">build packs</a>.</em></em></p>
              
              <hr>
              
              <p>A couple of days ago Heroku <a href="http://blog.heroku.com/archives/2011/8/25/java/">announced</a> support for Java on their servers. I took the opportunity to try and get a Sinatra app running on Heroku using the Java support to boostrap JRuby.</p>
              
              <p>In Heroku&rsquo;s blog post they mentioned that Matthew Rodley had already put a Rails app on Heroku by simply adding JRuby to <code>pom.xml</code>. Looking at what Matthew had done it didn&rsquo;t seem to hard to get something working. First thing is to setup a simple Sinatra app.</p>
              <pre class="highlight ruby"><span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>&#x000A;<span class="nb">require</span> <span class="s2">&quot;bundler&quot;</span>&#x000A;&#x000A;<span class="no">Bundler</span><span class="nf">.require</span>&#x000A;&#x000A;<span class="nb">require</span> <span class="s2">&quot;sinatra&quot;</span>&#x000A;&#x000A;<span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>&#x000A;  <span class="s2">&quot;Hello World&quot;</span>&#x000A;<span class="k">end</span></pre>
              <p>Nothing complicated there.</p>
              
              <p>There are a few potential gotchas when working with Heroku though. From what I can tell if there is a <code>config.ru</code> or <code>Gemfile</code> present in the root application directory, Heroku will ignore the <code>pom.xml</code> and start the application using Ruby. I like Matthew&rsquo;s approach of renaming the <code>Gemfile</code> to <code>Jemfile</code>.</p>
              <pre class="highlight text">source &quot;http://rubygems.org&quot;&#x000A;&#x000A;gem &quot;sinatra&quot;&#x000A;gem &quot;trinidad&quot;</pre>
              <p>The process of running a Java app on Heroku goes like this:</p>
              
              <ol>
              <li>Heroku detects <code>pom.xml</code> and runs a <code>mvn install</code>. This should install any Java dependancies.</li>
              <li>Heroku reads <code>Procfile</code> and executes <code>web</code> command.</li>
              </ol>
              
              <p>Normally, the command that is in the Procfile is a script that is generated by the <code>maven-appassembler-plugin</code>. This script looks up the location of the JRE and sets the appropriate Java <code>classpath</code> so dependancies can be resolved when launching a Java application. The main difference with JRuby is what this script calls to launch our Ruby app. Rather than <code>java net.example.MyApp</code> we want something like <code>java org.jruby.Main -S trinidad -p 4567</code>.</p>
              
              <p>Copying what Matthew did, I copied his script and placed in the <code>script</code> folder. Then I placed the following line in my <code>Procfile</code>.</p>
              <pre class="highlight text">web: sh script/jruby -S trinidad -p $PORT</pre>
              <p>The script <code>jruby</code> is a slightly modified version of a startup script that get&rsquo;s generated by the <code>maven-appassembler-plugin</code>. Heroku will execute the above command when trying to start our app.</p>
              
              <p>Lastly in our <code>pom.xml</code> we need to tell <code>maven</code> to pull down both JRuby and the JRuby rake plugin. JRuby also needs the gems that are required by our app. Again Matthew&rsquo;s <code>pom.xml</code> does all of this.</p>
              <pre class="highlight xml"><span class="nt">&lt;project&gt;</span>&#x000A;    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>&#x000A;    <span class="nt">&lt;groupId&gt;</span>au.com.mathew<span class="nt">&lt;/groupId&gt;</span>&#x000A;    <span class="nt">&lt;artifactId&gt;</span>jruby-heroku<span class="nt">&lt;/artifactId&gt;</span>&#x000A;    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>&#x000A;    <span class="nt">&lt;name&gt;</span>webapp<span class="nt">&lt;/name&gt;</span>&#x000A;    <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>&#x000A;    <span class="nt">&lt;dependencies&gt;</span>&#x000A;        <span class="nt">&lt;dependency&gt;</span>&#x000A;            <span class="nt">&lt;groupId&gt;</span>org.jruby<span class="nt">&lt;/groupId&gt;</span>&#x000A;            <span class="nt">&lt;artifactId&gt;</span>jruby-complete<span class="nt">&lt;/artifactId&gt;</span>&#x000A;            <span class="nt">&lt;version&gt;</span>1.6.3<span class="nt">&lt;/version&gt;</span>&#x000A;        <span class="nt">&lt;/dependency&gt;</span>&#x000A;        <span class="nt">&lt;dependency&gt;</span>&#x000A;            <span class="nt">&lt;groupId&gt;</span>org.jruby.plugins<span class="nt">&lt;/groupId&gt;</span>&#x000A;            <span class="nt">&lt;artifactId&gt;</span>jruby-rake-plugin<span class="nt">&lt;/artifactId&gt;</span>&#x000A;            <span class="nt">&lt;version&gt;</span>1.6.3<span class="nt">&lt;/version&gt;</span>&#x000A;        <span class="nt">&lt;/dependency&gt;</span>&#x000A;    <span class="nt">&lt;/dependencies&gt;</span>&#x000A;    <span class="nt">&lt;build&gt;</span>&#x000A;        <span class="nt">&lt;plugins&gt;</span>&#x000A;            <span class="nt">&lt;plugin&gt;</span>&#x000A;                <span class="nt">&lt;groupId&gt;</span>org.jruby.plugins<span class="nt">&lt;/groupId&gt;</span>&#x000A;                <span class="nt">&lt;artifactId&gt;</span>jruby-rake-plugin<span class="nt">&lt;/artifactId&gt;</span>&#x000A;                <span class="nt">&lt;version&gt;</span>1.6.3<span class="nt">&lt;/version&gt;</span>&#x000A;                <span class="nt">&lt;executions&gt;</span>&#x000A;                    <span class="nt">&lt;execution&gt;</span>&#x000A;                        <span class="nt">&lt;id&gt;</span>install-bundler<span class="nt">&lt;/id&gt;</span>&#x000A;                        <span class="nt">&lt;phase&gt;</span>process-resources<span class="nt">&lt;/phase&gt;</span>&#x000A;                        <span class="nt">&lt;goals&gt;</span>&#x000A;                            <span class="nt">&lt;goal&gt;</span>jruby<span class="nt">&lt;/goal&gt;</span>&#x000A;                        <span class="nt">&lt;/goals&gt;</span>&#x000A;                        <span class="nt">&lt;configuration&gt;</span>&#x000A;                            <span class="nt">&lt;args&gt;</span>-S gem install bundler --no-ri --no-rdoc --install-dir .gems<span class="nt">&lt;/args&gt;</span>&#x000A;                        <span class="nt">&lt;/configuration&gt;</span>&#x000A;                    <span class="nt">&lt;/execution&gt;</span>&#x000A;                    <span class="nt">&lt;execution&gt;</span>&#x000A;                        <span class="nt">&lt;id&gt;</span>bundle-install<span class="nt">&lt;/id&gt;</span>&#x000A;                        <span class="nt">&lt;phase&gt;</span>process-resources<span class="nt">&lt;/phase&gt;</span>&#x000A;                        <span class="nt">&lt;goals&gt;</span>&#x000A;                            <span class="nt">&lt;goal&gt;</span>jruby<span class="nt">&lt;/goal&gt;</span>&#x000A;                        <span class="nt">&lt;/goals&gt;</span>&#x000A;                        <span class="nt">&lt;configuration&gt;</span>&#x000A;                            <span class="nt">&lt;args&gt;</span>&#x000A;                                -e ENV[&#39;GEM_HOME&#39;]=File.join(Dir.pwd,&#39;.gems&#39;);ENV[&#39;GEM_PATH&#39;]=File.join(Dir.pwd,&#39;.gems&#39;);ENV[&#39;BUNDLE_GEMFILE&#39;]=File.join(Dir.pwd,&#39;Jemfile&#39;);require&#39;rubygems&#39;;require&#39;bundler&#39;;require&#39;bundler/cli&#39;;cli=Bundler::CLI.new;cli.install&#x000A;                            <span class="nt">&lt;/args&gt;</span>&#x000A;                        <span class="nt">&lt;/configuration&gt;</span>&#x000A;                    <span class="nt">&lt;/execution&gt;</span>&#x000A;                <span class="nt">&lt;/executions&gt;</span>&#x000A;            <span class="nt">&lt;/plugin&gt;</span>&#x000A;        <span class="nt">&lt;/plugins&gt;</span>&#x000A;    <span class="nt">&lt;/build&gt;</span>&#x000A;<span class="nt">&lt;/project&gt;</span></pre>
              <p>The important part to note here is the in the plugins section. We&rsquo;re telling <code>maven</code> to execute a couple of commands so that the required gems get installed into JRuby. First it executes:</p>
              <pre class="highlight text">jruby -S gem install bundler --no-ri --no-rdoc --install-dir .gems</pre>
              <p>This installs bundler. Then the following is executed to install the required gems.</p>
              <pre class="highlight text">jruby -e ENV[&#39;GEM_HOME&#39;]=File.join(Dir.pwd,&#39;.gems&#39;); \&#x000A;   ENV[&#39;GEM_PATH&#39;]=File.join(Dir.pwd,&#39;.gems&#39;); \&#x000A;   ENV[&#39;BUNDLE_GEMFILE&#39;]=File.join(Dir.pwd,&#39;Jemfile&#39;); \&#x000A;    require&#39;rubygems&#39;; \&#x000A;    require&#39;bundler&#39;; \&#x000A;    require&#39;bundler/cli&#39;; \&#x000A;    cli=Bundler::CLI.new; \&#x000A;    cli.install</pre>
              <p>Note that Gemfile is specified as the new name <code>Jemfile</code>.</p>
              
              <p>To summarise, this is what occurs when a push is sent to Heroku:</p>
              
              <ol>
              <li>Heroku detects <code>pom.xml</code> and runs <code>mvn install</code>.</li>
              <li><code>maven</code> reads <code>pom.xml</code> and does the following:
              
              <ul>
              <li>Gets JRuby</li>
              <li>Installs the bundler gem using JRuby</li>
              <li>Installs the required gems to <code>.gems</code> using JRuby.</li>
              </ul></li>
              <li>Heroku inspects the <code>Procfile</code> and calls the <code>web</code> process that is defined.</li>
              <li><code>script/jruby -S trinidad -p &lt;port&gt;</code> is called.</li>
              </ol>
              
              <p>There was one problem that occured with the <code>jruby</code> script though. I was getting class not found errors from Java and the application would fail to load. By default it seems the <code>REPO</code> environment variable is undefined. The script default value to set if <code>REPO</code> is unavailable is <code>$BASEDIR/repo</code>, but this evaluates to <code>app/repo</code>, which doesn&rsquo;t exist. <code>maven</code> installs dependancies to <code>.m2/repository</code> so I changed it to the following:</p>
              <pre class="highlight text">if [ -z &quot;$REPO&quot; ]&#x000A;then&#x000A;    REPO=&quot;$BASEDIR&quot;/.m2/repository&#x000A;fi</pre>
              <p>I&rsquo;ve put this test project on <a href="https://github.com/Soliah/sinatra-jruby-heroku">GitHub</a> for those interested.</p>
              <hr>
              <div id='disqus_thread'></div>
              <noscript>
                <a href='http://chowie.disqus.com/?url=ref'>
                  View the discussion thread.
                </a>
              </noscript>
            </div>
          </div>
        </div>
      </section>
    </div>
    <footer class='container'>
      <div class='row'>
        <div class='col-md-12'>
          &copy; 2011-13 Christopher Chow. Powered by
          <a href='http://middlemanapp.com'>Middleman.</a>
          Hosted on
          <a href='http://http://pages.github.com'>GitHub Pages</a>
        </div>
      </div>
    </footer>
  </body>
  <script src="/javascripts/application.js" type="text/javascript"></script>
  <script src="http://disqus.com/forums/chowie/embed.js" type="text/javascript"></script>
</html>

